<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="characteristic-styles.html">
<link rel="import" href="characteristic-template.html">
<link rel="import" href="tab-selection.html">

<dom-module id="active-slot-characteristic">
    <template>
        <style include="characteristic-styles"></style>

        <characteristic-template number="2" name="Active Slot" loading="[[loading]]" data-loaded="[[dataLoaded]]">
            <section class="padded">
                <tab-selection selected="{{activeSlot}}" selected-class="success" loading="[[loading]]">
                    <template is="dom-repeat" items="[[slots]]">
                        <button value="[[item.value]]">[[item.label]]</button>
                    </template>
                </tab-selection>
            </section>
            <section class="padded messages">
                <p>Number of slots is based on <strong>Max supported total slots</strong> capability.</p>
                <p>Subsequent writes to other characteristics will act on the active slot.</p>
            </section>
        </characteristic-template>
    </template>

    <script>
        class ActiveSlotCharacteristic extends Polymer.Element {
            static get is() {
                return 'active-slot-characteristic';
            }

            static get properties() {
                return {
                    service: {
                        type: Object,
                        observer: 'observeService'
                    },
                    uuids: Object,
                    characteristic: Object,
                    loading: {
                        type: Boolean,
                        value: true
                    },
                    dataLoaded: {
                        type: Boolean,
                        value: false
                    },
                    activeSlot: {
                        type: String,
                        observer: 'observeActiveSlot'
                    },
                    slots: Array
                };
            }

            async observeService(service) {
                if (service) {
                    this.characteristic = await service.getCharacteristic(this.uuids.activeSlot);
                    const binaryData = await this.characteristic.readValue();

                    const characteristic = await service.getCharacteristic(this.uuids.capabilities);
                    const capabilities = await characteristic.readValue();
                    const maxSupportedTotalSlots = capabilities.getUint8(1);
                    const slots = [];
                    for (let i = 0; i < maxSupportedTotalSlots; i++) {
                        slots.push({ label: `SLOT #${i + 1}`, value: i });
                    }
                    this.slots = slots;
                    this.activeSlot = String(binaryData.getUint8(0));

                    this.loading = false;
                    this.dataLoaded = true;
                } else {
                    this.loading = true;
                    this.dataLoaded = false;
                }
            }

            async observeActiveSlot(activeSlot, previousValue) {
                const binaryData = new Uint8Array([activeSlot]);

                this.loading = true;
                await this.characteristic.writeValue(binaryData);
                this.loading = false;

                if (previousValue) {
                    this.dispatchEvent(new CustomEvent('active-slot-changed', {
                        detail: { value: activeSlot }
                    }));
                }
            }
        }

        customElements.define(ActiveSlotCharacteristic.is, ActiveSlotCharacteristic);
    </script>
</dom-module>
