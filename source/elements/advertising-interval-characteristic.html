<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="characteristic-styles.html">
<link rel="import" href="characteristic-template.html">
<link rel="import" href="characteristic-value.html">
<link rel="import" href="flexible-input.html">
<link rel="import" href="value-with-unit.html">

<dom-module id="advertising-interval-characteristic">
    <template>
        <style include="characteristic-styles"></style>

        <characteristic-template number="3" name="Advertising Interval" loading="[[loading]]" data-loaded="[[dataLoaded]]">
            <section>
                <characteristic-value label="Advertising Interval">
                    <value-with-unit unit="ms">
                        <flexible-input value="{{advertisingInterval}}" on-value-changed="onAdvertisingIntervalChanged"></flexible-input>
                    </value-with-unit>
                </characteristic-value>
            </section>
            <section class="padded messages">
                <template is="dom-if" if="[[isVariableAdvIntervalSupported]]">
                    <p>Writing a value to this characteristic will set the advertising interval for <strong>[[activeSlotLabel]]</strong>.</p>
                </template>
                <template is="dom-if" if="[[!isVariableAdvIntervalSupported]]">
                    <p class="warning">Because <strong>variable ADV interval</strong> is not supported, writing a value to this characteristic will set the advertising interval for all slots.</p>
                </template>
            </section>
        </characteristic-template>
    </template>

    <script>
        class AdvertisingIntervalCharacteristic extends Polymer.Element {
            static get is() {
                return 'advertising-interval-characteristic';
            }

            static get properties() {
                return {
                    service: {
                        type: Object,
                        observer: 'observeService'
                    },
                    uuids: Object,
                    characteristic: Object,
                    loading: {
                        type: Boolean,
                        value: true
                    },
                    dataLoaded: {
                        type: Boolean,
                        value: false
                    },
                    advertisingInterval: String,
                    activeSlotLabel: String,
                    isVariableAdvIntervalSupported: {
                        type: Boolean,
                        value: true
                    }
                };
            }

            async observeService(service) {
                if (service) {
                    this.characteristic = await this.service.getCharacteristic(this.uuids.advertisingInterval);
                    const characteristic = await this.service.getCharacteristic(this.uuids.activeSlot);
                    const binaryData = await this.characteristic.readValue();
                    const activeSlotData = await characteristic.readValue();
                    const activeSlot = activeSlotData.getUint8(0);

                    this.activeSlotLabel = `Slot #${activeSlot + 1}`;
                    this.advertisingInterval = String(binaryData.getUint16(0));

                    this.loading = false;
                    this.dataLoaded = true;
                } else {
                    this.loading = true;
                    this.dataLoaded = false;
                }
            }

            onAdvertisingIntervalChanged(e) {
                console.log(e.detail.value);
            }

            async refresh() {
                this.loading = true;

                const characteristic = await this.service.getCharacteristic(this.uuids.activeSlot);
                const binaryData = await this.characteristic.readValue();
                const activeSlotData = await characteristic.readValue();
                const activeSlot = activeSlotData.getUint8(0);

                this.activeSlotLabel = `Slot #${activeSlot + 1}`;
                this.advertisingInterval = String(binaryData.getUint16(0));
                this.loading = false;
            }
        }

        customElements.define(AdvertisingIntervalCharacteristic.is, AdvertisingIntervalCharacteristic);
    </script>
</dom-module>
